# 第六章：Roguelike 系统设计

## 6.1 系统概述

### 核心理念
> "每局都是新的修炼，每次选择塑造独特的剑道"

通过随机强化系统，让每局游戏都有不同的体验。玩家需要根据当前 Build 和局势做出选择，形成独特的战斗风格。

### 选择时机
```
强化选择触发点：
┌─────────────────────────────────────────┐
│ 1. 波次结束                             │
│    └─ 每波结束后弹出三选一              │
│                                         │
│ 2. Boss 击杀                            │
│    └─ 额外获得一次稀有选择              │
│                                         │
│ 3. 特殊掉落                             │
│    └─ 精英敌人掉落直接获取              │
└─────────────────────────────────────────┘
```

## 6.2 强化道具系统

### 稀有度分级
| 稀有度 | 颜色 | 出现概率 | 效果强度 |
|--------|------|----------|----------|
| **普通** | 白色 | 60% | 基础提升 |
| **稀有** | 蓝色 | 25% | 中等提升 |
| **史诗** | 紫色 | 12% | 强力提升 |
| **传说** | 金色 | 3% | 极强/特殊效果 |

### 强化类别
| 类别 | 图标 | 效果类型 |
|------|------|----------|
| **属性** | ⬆️ | 直接提升基础属性 |
| **技能** | ⚔️ | 增强或改变技能 |
| **特效** | ✨ | 触发型被动效果 |
| **生存** | ❤️ | 提升生存能力 |

## 6.3 强化道具列表

### 属性类强化

| ID | 名称 | 稀有度 | 效果 | 可叠加 |
|----|------|--------|------|--------|
| A01 | 锋锐 | 普通 | ATK +3 | ✓ |
| A02 | 坚韧 | 普通 | HP +15 | ✓ |
| A03 | 迅捷 | 普通 | SPD +15 | ✓ |
| A04 | 专注 | 稀有 | CRIT +5% | ✓ |
| A05 | 猛击 | 稀有 | CRITDMG +20% | ✓ |
| A06 | 剑心 | 史诗 | ATK +10, CRIT +3% | ✓ |
| A07 | 不动明王 | 传说 | ATK +20%, HP +30% | ✗ |

### 技能类强化

| ID | 名称 | 稀有度 | 效果 |
|----|------|--------|------|
| S01 | 剑气延长 | 普通 | 普攻范围 +20% |
| S02 | 快速冷却 | 普通 | 冷却缩减 +8% |
| S03 | 横扫千军 | 稀有 | 剑气横扫范围 +50% |
| S04 | 瞬步强化 | 稀有 | 瞬步斩可穿透敌人 |
| S05 | 护体反震 | 稀有 | 护体真气反弹伤害 +100% |
| S06 | 剑域扩展 | 史诗 | 剑域范围 +50%，持续 +1s |
| S07 | 万剑归宗 | 传说 | 获得新终极技能 |

### 特效类强化

| ID | 名称 | 稀有度 | 效果 |
|----|------|--------|------|
| E01 | 连斩 | 普通 | 连击 50+ 时，ATK +10% |
| E02 | 嗜血 | 稀有 | 击杀回复 2 HP |
| E03 | 剑气外溢 | 稀有 | 攻击有 15% 概率触发额外剑气 |
| E04 | 处刑者 | 史诗 | 对 HP<30% 敌人伤害 +50% |
| E05 | 无双之力 | 史诗 | 无双状态期间无敌 |
| E06 | 轮回 | 传说 | 死亡时复活，HP 30%（每局一次） |
| E07 | 剑道通神 | 传说 | 所有技能伤害 +30%，冷却 -20% |

### 生存类强化

| ID | 名称 | 稀有度 | 效果 |
|----|------|--------|------|
| H01 | 气血两旺 | 普通 | HP +25 |
| H02 | 铁布衫 | 普通 | DEF +3 |
| H03 | 回春 | 稀有 | 每秒恢复 1 HP |
| H04 | 吸血 | 稀有 | 造成伤害回复 3% HP |
| H05 | 金钟罩 | 史诗 | 受到伤害 -15% |
| H06 | 不死金身 | 传说 | HP 低于 10% 时，受伤 -50% |

## 6.4 选择机制

### 三选一界面
```
波次结束选择界面：

┌─────────────────────────────────────────┐
│           选择你的强化                  │
│                                         │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │ [稀有]  │ │ [普通]  │ │ [普通]  │   │
│  │         │ │         │ │         │   │
│  │  ⚔️     │ │  ⬆️     │ │  ❤️     │   │
│  │         │ │         │ │         │   │
│  │ 横扫千军│ │  锋锐   │ │ 气血两旺│   │
│  │         │ │         │ │         │   │
│  │范围+50% │ │ ATK +3  │ │ HP +25  │   │
│  └─────────┘ └─────────┘ └─────────┘   │
│                                         │
│        按 1/2/3 或点击选择              │
└─────────────────────────────────────────┘
```

### 概率调整机制
```
保底机制：
- 连续 5 波未见稀有 → 下一波稀有概率 +20%
- 连续 10 波未见史诗 → 下一波史诗概率 +15%
- Boss 波必出至少 1 个史诗选项

去重机制：
- 三个选项不会重复
- 已满级的可叠加强化概率降低
```

### 选项生成算法
```javascript
function generateChoices(playerState, waveNumber) {
  const pool = getAvailableBuffs(playerState);
  const choices = [];

  for (let i = 0; i < 3; i++) {
    const rarity = rollRarity(waveNumber, playerState.pity);
    const candidates = pool.filter(b => b.rarity === rarity);
    const choice = weightedRandom(candidates, playerState.build);
    choices.push(choice);
    pool.remove(choice); // 去重
  }

  return choices;
}
```

## 6.5 Build 构筑

### Build 方向
| Build 类型 | 核心强化 | 玩法特点 |
|------------|----------|----------|
| **暴击流** | 专注、猛击、处刑者 | 追求高额单次伤害 |
| **攻速流** | 迅捷、快速冷却、连斩 | 高频攻击，连击维持 |
| **范围流** | 剑气延长、横扫千军、剑域扩展 | 大范围清怪 |
| **生存流** | 回春、吸血、金钟罩 | 高容错，持久战 |
| **技能流** | 剑道通神、快速冷却 | 频繁释放技能 |

### Build 联动效果
某些强化组合会触发额外效果：

| 组合 | 需要强化 | 额外效果 |
|------|----------|----------|
| 剑道大成 | 剑心 + 剑道通神 | 技能无冷却期间 |
| 不灭金身 | 不死金身 + 轮回 | 复活后无敌 3 秒 |
| 收割者 | 处刑者 + 嗜血 | 击杀回复翻倍 |

## 6.6 数据结构

```javascript
// 强化道具数据结构
const Buff = {
  id: 'A01',
  name: '锋锐',
  rarity: 'common', // common, rare, epic, legendary
  category: 'attribute', // attribute, skill, effect, survival
  icon: '⬆️',
  description: 'ATK +3',
  stackable: true,
  maxStacks: 10,
  effect: {
    type: 'stat_add',
    stat: 'atk',
    value: 3
  }
};

// 玩家强化状态
const PlayerBuffs = {
  active: [
    { buffId: 'A01', stacks: 3 },
    { buffId: 'S01', stacks: 1 },
    { buffId: 'E02', stacks: 1 }
  ],

  // 保底计数
  pity: {
    rare: 0,
    epic: 0,
    legendary: 0
  }
};
```

---

*下一章：无尽模式框架设计*
