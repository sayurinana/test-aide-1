# 任务细则：攻击方式选择与强化过滤

## 任务目标

解决两个核心问题：
1. 游戏过程中无法获得新的攻击方式
2. 强化选项会出现玩家未拥有的攻击方式的专属强化

## 成功标准

1. 玩家在游戏过程中可以获得新的攻击方式（不仅限于开局选择）
2. 强化选项只显示玩家已拥有攻击方式的专属强化
3. 不破坏现有游戏平衡和体验

## 具体步骤

### 步骤 1：实现强化过滤机制

**目标**：修改 `RoguelikeSystem.generateChoices()` 方法，过滤掉玩家未拥有攻击方式的专属强化

**修改文件**：`src/systems/RoguelikeSystem.js`

**实现方案**：
1. 在 `generateChoices()` 方法中获取玩家已拥有的攻击类型列表
2. 在过滤候选强化时，检查 `category === 'attack'` 的强化
3. 如果是普攻类强化，检查其 `attackType` 是否在玩家已拥有的攻击列表中
4. 不在列表中的普攻强化不会出现在选项中

**验证标准**：
- 只拥有"挥砍"攻击时，不会出现"射箭"、"法球"等其他攻击的专属强化
- 拥有多种攻击时，对应的专属强化都可以出现

### 步骤 2：添加"获得新攻击方式"的强化道具

**目标**：在强化系统中添加特殊强化，让玩家可以获得新的攻击方式

**修改文件**：`src/data/BuffData.js`

**实现方案**：
1. 添加新的强化类别或使用现有类别
2. 添加"新攻击方式"强化道具（稀有度：稀有或史诗）
3. 效果类型为 `new_attack`，触发攻击选择界面

**新增强化道具**：
```javascript
{
  id: 'ATK_NEW',
  name: '新的力量',
  rarity: 'rare',
  category: 'attack',
  description: '获得一种新的攻击方式',
  stackable: false,
  effect: { type: 'new_attack' }
}
```

### 步骤 3：实现新攻击方式选择逻辑

**目标**：当玩家选择"新的力量"强化时，弹出攻击方式选择界面

**修改文件**：
- `src/systems/RoguelikeSystem.js`
- `src/scenes/GameScene.js`
- `src/scenes/AttackSelectScene.js`（可能需要修改以支持过滤已拥有的攻击）

**实现方案**：
1. 在 `RoguelikeSystem.applyBuffEffect()` 中处理 `new_attack` 类型
2. 触发 `GameScene` 显示攻击选择界面
3. 修改 `AttackSelectScene` 以支持过滤已拥有的攻击类型
4. 选择后将新攻击添加到 `AttackManager`

**验证标准**：
- 选择"新的力量"后弹出攻击选择界面
- 已拥有的攻击方式不会出现在选择界面中
- 选择新攻击后正确添加到玩家的攻击列表

### 步骤 4：过滤"新的力量"强化的出现条件

**目标**：当玩家已拥有所有攻击方式时，"新的力量"强化不再出现

**修改文件**：`src/systems/RoguelikeSystem.js`

**实现方案**：
1. 在 `generateChoices()` 中检查玩家已拥有的攻击数量
2. 如果已拥有全部 6 种攻击，过滤掉 `ATK_NEW` 强化

**验证标准**：
- 拥有 1-5 种攻击时，"新的力量"可以出现
- 拥有全部 6 种攻击时，"新的力量"不再出现

## 依赖关系

```
步骤 1（强化过滤）→ 步骤 2（添加强化道具）→ 步骤 3（选择逻辑）→ 步骤 4（条件过滤）
```

## 风险评估

| 风险 | 影响 | 应对方案 |
|------|------|----------|
| 攻击选择界面重复启动 | 中 | 添加状态锁，防止重复触发 |
| 新攻击的碰撞检测未设置 | 高 | 复用 `setupProjectileCollision` 方法 |
| 游戏平衡性变化 | 低 | "新的力量"设为稀有级别，控制出现频率 |

## 备注

- 本任务不涉及 UI 样式修改
- 保持与现有代码风格一致
- 不添加新的依赖库
